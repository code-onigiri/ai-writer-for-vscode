# Implementation Plan

- [x] 1. プロジェクト基盤を整備する
  - Base・Vscode-ext・LMTAPI-vscodeをpnpmワークスペースで統合運用できる状態を用意する。
  - 共通ビルド/テストスクリプトと型設定を揃え、後続レイヤーの開発が一貫した環境で進められるようにする。
  - _Requirements: R1, R2, R3, R4, R5, R6_

- [x] 1.1 pnpmワークスペースとパッケージ構成をセットアップする
  - `pnpm-workspace.yaml`でBase・Vscode-ext・LMTAPI-vscode各パッケージを登録し、相互参照のパス解決を整える。
  - 各パッケージに共通のtsconfigとESLint設定を継承させ、strictモードとビルドターゲットを統一する。
  - pnpmスクリプトにビルド・テスト・型チェックの共通コマンドを追加し、CI/ローカルで同じ操作手順を確立する。
  - _Requirements: R1, R2, R3, R4, R5, R6_

- [x] 1.2 開発フローと秘密情報管理の基盤を整える
  - `.env.example`や設定ガイドを用意してAPIキー・Gemini CLIプロバイダーが参照するCLIパスなどの入力経路を定義する。
  - VS CodeのSecretStorageとBase層の設定サービスを連携させ、プロバイダーごとの資格情報を安全に参照できるようにする。
  - 監査ログ出力やデバッグトレーシングの初期設定を組み込み、後続の実装検証が行える状態にする。
  - _Requirements: R1, R2, R3, R4, R5, R6_

- [x] 2. Baseレイヤーの反復オーケストレーションを構築する
  - ステートマシンとオーケストレータでアウトライン/ドラフト生成ワークフローを制御できるようにする。
  - テンプレート・ペルソナ・遵守記録を反復サイクルの各ステップで参照できる仕組みを組み込む。
  - _Requirements: R1, R2, R3, R6_

- [x] 2.1 Iteration Engineで反復ステートマシンを実装する
  - アウトライン用とドラフト用モードの遷移表を定義し、生成→批判→考察→質問→再生成→承認の順序を強制する。
  - 無効遷移検知と違反フィードバックを返す仕組みを作り、UIが再入力を促せるようにする。
  - ステップ記録や要求済み次ステップをImmutableに保持するユニットテストを作成する。
  - _Requirements: R1, R2, R6_

- [ ] 2.2 Generation Orchestratorでセッション管理を実装する
  - Iteration Engineとテンプレート/ペルソナ情報を統合し、各ステップの入力・出力・履歴を集約する。
  - AISDK Hub呼び出しとストレージ保存を挟み、セッション再開や差分要約が参照できるようにする。
  - エラー発生時にリカバリーヒントを返す結果オブジェクトを設計し、上位レイヤーからの扱いを統一する。
  - _Requirements: R1, R2, R4, R6_

- [ ] 2.3 Template Registryでテンプレートと遵守記録を管理する
  - テンプレート作成・読み込み・ポイント更新APIを提供し、パーソナライズ指示の優先度を保持する。
  - 各ポイントごとの遵守スナップショットを記録し、レポート生成に備えるデータ構造を整える。
  - テンプレートとペルソナの整合性検証ロジックを実装する。
  - _Requirements: R2, R3, R6_

- [ ] 2.4 Persona Managerでパーソナライゼーション適用を制御する
  - 質問回答から抽出した属性を保存し、テンプレート適用時にトーンやON/OFFトグルへ反映する機能を実装する。
  - 適用済みパラメータの履歴とバージョン差分を追跡し、ログ出力にフックする。
  - 無効な組み合わせを検出するバリデーションを追加する。
  - _Requirements: R3, R6_

- [ ] 3. AISDK Hubとプロバイダー連携を実装する
  - Vercel AI SDKのプロバイダー登録機構でOpenAI・Gemini API・Gemini CLI・LMTブリッジを一元化する。
  - テンプレート指示やフェールオーバー制御をHubで担い、各チャネルの責務を明確化する。
  - _Requirements: R1, R2, R5, R6_

- [ ] 3.1 AISDK Hubのレジストリと共通インターフェースを整える
  - `createProviderRegistry`でレジストリを生成し、Base層から`execute`/`stream`で呼び出せるAPIを提供する。
  - プロンプト構築時にテンプレートポイントとペルソナ情報を差し込むミドルウェアを実装する。
  - 失敗時にフォールバック順序を決定するポリシーとリトライ制御を組み込む。
  - _Requirements: R1, R2, R5, R6_

- [ ] 3.2 OpenAI・Gemini APIチャネルを登録する
  - APIキー取得とエンドポイント設定をレジストリへ登録し、温度や最大トークンなどのデフォルト設定を定義する。
  - ストリーミング応答と構造化出力をBase層に引き渡す整形処理を実装する。
  - リクエスト/レスポンスの監査ログフックを用意する。
  - _Requirements: R1, R2, R5_

- [ ] 3.3 Gemini CLIプロバイダーを組み込む
  - `ai-sdk-provider-gemini-cli` を AISDK Hub のレジストリへ登録し、チャネルキーとフォールバック優先度を定義する。
  - プロバイダー構成で CLI パスやモデル指定を環境変数／設定サービスから受け取り、資格情報の検証を実装する。
  - プロバイダーから返却されるストリーム／エラーを Hub の Result 型へ正規化し、再試行ポリシーを統合する。
  - _Requirements: R5_

- [ ] 3.4 LMTブリッジ向けチャネルを登録する
  - VS Code Language Model Tool APIからの呼び出し内容をHubのプロンプト形式へ変換するインターフェースを用意する。
  - Tool応答をHub経由で返し、テンプレート遵守情報を追加できるようにする。
  - _Requirements: R5, R6_

- [ ] 4. ストレージとバージョン管理基盤を構築する
  - セッションデータとテンプレートを`.ai-writer/`配下に保存し、Git連携による差分管理を可能にする。
  - 監査ログと統計を高頻度で出力できる仕組みを提供し、推敲サイクルの証跡を残す。
  - _Requirements: R3, R4, R6_

- [ ] 4.1 セッション/テンプレート保存を実装する
  - セッションスナップショットをJSONで保存し、復元時にIteration Engineへ状態を渡せるようにする。
  - テンプレート・ペルソナ・遵守結果をフォルダ別に整理し、参照と更新の原子性を保つ。
  - 保存処理の競合検出とロールバック手順を実装する。
  - _Requirements: R1, R2, R3, R4, R6_

- [ ] 4.2 Git連携と差分表示を整備する
  - Draft保存時に差分プレビューを生成し、承認後にGitコミットを実行するフローを組み込む。
  - 過去版比較ビュー用に差分データをセクション単位で保持する。
  - _Requirements: R4_

- [ ] 4.3 監査ログと統計集計を実装する
  - 各ステップ実行やプロバイダー呼び出しをJSON Linesで書き出し、タイムスタンプとユーザーを記録する。
  - プロバイダー別利用統計とテンプレート遵守率を集計するロジックを追加する。
  - _Requirements: R3, R5, R6_

- [ ] 5. VS Code拡張UIと操作フローを実装する
  - コマンドやWebviewで反復ワークフローを操作できるUIを提供し、生成結果と批判内容を確認・再生成できるようにする。
  - テンプレート編集やペルソナ設定を行えるビューを整備する。
  - _Requirements: R1, R2, R3, R5, R6_

- [ ] 5.1 コマンドコントローラを構築する
  - 主要コマンド（アウトライン開始、ドラフト生成、既存文章推敲、テンプレート管理）を登録し、Orchestratorへ引き回す。
  - コマンド実行前の入力バリデーションとエラーハンドリングを整備する。
  - _Requirements: R1, R2, R5_

- [ ] 5.2 進行状況Webviewとサイクル操作UIを実装する
  - ステップごとの生成/批判/再生成結果をタイムライン表示し、ユーザーが再実行を指示できるUIを提供する。
  - Webviewからの操作イベントをOrchestratorへ伝播させ、ステート違反時に注記を表示する。
  - _Requirements: R1, R2_

- [ ] 5.3 テンプレート・ペルソナ編集ビューを構築する
  - テンプレートのポイント追加・優先度設定・遵守レポート表示を行うUIを実装する。
  - ペルソナ設定のON/OFFトグルや質問回答履歴を管理するインタフェースを追加する。
  - _Requirements: R3, R6_

- [ ] 5.4 既存文章推敲とプロバイダー切替UIを提供する
  - ファイル選択とハイライト表示で編集対象セクションを明示し、改善提案を受け入れ/拒否できるようにする。
  - プロバイダー選択および設定検証結果を表示するUIを実装する。
  - _Requirements: R5_

- [ ] 6. Language Model Tool APIとの連携を実装する
  - LMT Provider BridgeでAISDK HubとVS Code APIを接続し、チャットプロバイダーとして動作させる。
  - モデルツール登録でアウトライン生成や批判タスクを直接呼び出せるようにする。
  - _Requirements: R1, R2, R5, R6_

- [ ] 6.1 LanguageModelChatProviderブリッジを実装する
  - 提供モデル一覧の公開、チャットリクエスト処理、トークンカウント計算を行う。
  - HubのレスポンスをVS CodeのProgress APIにストリームし、エラー時のフォールバック結果を返す。
  - _Requirements: R1, R2, R5_

- [ ] 6.2 Language Model Toolを登録する
  - アウトライン生成、批判、テンプレート適用などのツールを登録し、入力スキーマでテンプレート/ペルソナを指定できるようにする。
  - `prepareInvocation`でユーザー確認文を提供し、SecretStorageの資格情報が揃っているか検証する。
  - _Requirements: R1, R2, R5, R6_

- [ ] 6.3 ツール呼び出しと遵守レポート連携を整備する
  - ツール実行結果をテンプレート遵守状況や監査ログに書き戻す処理を実装する。
  - ツール連携時のテンプレートポイント差し替えや一時上書きをサポートする。
  - _Requirements: R5, R6_

- [ ] 7. 品質保証と運用準備を行う
  - 単体/統合/UXテストを通じて反復ワークフローとプロバイダー連携を検証する。
  - セキュリティ・性能・障害時リカバリの観点を確認し、運用ガードレールを整備する。
  - _Requirements: R1, R2, R3, R4, R5, R6_

- [ ] 7.1 Baseレイヤーの単体テストを整備する
  - Iteration Engine、Generation Orchestrator、Template Registry、Persona Managerのユニットテストを作成する。
  - 異常系（無効遷移、テンプレート不整合、資格情報欠落）を網羅する。
  - _Requirements: R1, R2, R3, R6_

- [ ] 7.2 統合・E2Eテストを構築する
  - VS Codeエクステンションテストでコマンド→Webview→Base→AISDK Hub→ストレージの一連の流れを検証する。
  - 既存文章推敲やテンプレート遵守レポート生成を含むシナリオを追加する。
  - _Requirements: R1, R2, R3, R4, R5, R6_

- [ ] 7.3 セキュリティ・性能・運用監視を確認する
  - SecretStorageと環境変数の権限チェック、ログ脱敏処理を検証する。
  - ストリーミング負荷やCLI多重起動時の性能テストを行い、閾値を設定する。
  - 監視用出力とエラーレポート導線を整備し、障害対応手順を明文化する。
  - _Requirements: R3, R4, R5_
